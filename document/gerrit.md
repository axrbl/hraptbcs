Gerrit 的设计理念和推荐的最佳实践是 主线迭代（Mainline Development），而不是传统的长期特性分支（Feature Branches）。这种模式的核心思想是 持续集成 和 小步快跑，通过频繁地将代码合并到主线（如 main 或 master 分支）来减少集成冲突和提高代码质量。

# 一、Gerrit 的主线迭代模式
## 1. 核心思想
* **主线优先** - 所有开发都直接基于主线分支进行，避免长期特性分支。
* **小提交** - 将大功能拆分为多个小提交，每个提交都是可独立审查和合并的。
* **持续集成** - 每次提交都通过自动化测试验证，确保主线始终处于可发布状态。

## 2. 开发流程
基于主线的开发 -
* 开发者从主线分支拉取最新代码。
* 在本地创建短期分支（或直接基于主线开发）。
* 完成一个小功能或修复后，提交代码到 Gerrit 进行审查。
* 审查通过后，代码直接合并到主线。

特性开发的拆分 - 
* 如果一个特性较大，可以将其拆分为多个小任务，每个任务独立开发、审查和合并。

## 3. 代码审查
* 每个提交都需要通过 Gerrit 的代码审查流程。
* 评审者可以提出修改意见，开发者通过 git commit --amend 更新提交。
* 提交通过验证（如 CI 测试）后，合并到主线。


# 二、主线迭代 vs 传统特性分支
## 1. 传统特性分支的缺点
* **集成延迟** - 特性分支长期存在，导致与主线分支的差异越来越大，合并时容易产生冲突。
* **测试滞后** - 特性分支的代码无法及时通过主线的自动化测试，可能隐藏潜在问题。
* **协作困难** - 多个特性分支并行开发时，开发者之间的协作和代码复用变得复杂。

## 2. 主线迭代的优势
* **快速反馈** - 每次提交都经过审查和测试，问题可以尽早发现和修复。
* **减少冲突** - 频繁合并到主线，避免大规模冲突。
* **持续可发布** - 主线始终处于稳定状态，随时可以发布。
* **简化流程** - 不需要管理大量的长期分支，降低维护成本。
* **代码复用** - 驱动团队的交付向模块化/层次化等现代软件可复用的高效率模式演进
* **技术积累** - 长期的主线迭代，有助于团队统一评估技术演进

# 三、Gerrit 主线迭代的最佳实践
## 1. 模块化设计
将项目按领域/层级拆分为多个独立仓库，降低耦合度。
* 每个团队负责一个或多个仓库，提高开发效率的同时便于长期技术演进
* 具体技术领域的模块化/分层实现的原则，方法，属于软件工程化能力的范畴，不在此介绍

## 2. 小步快跑
将大功能拆分为多个小任务，每个任务对应一个独立的提交，多个提交最终完成该功能的实现/升级。
* 使用 repo sync 定期同步所有仓库，在开发前确保本地代码是最新的，同时避免提交时的代码冲突。
* 尽最大可能保持每个提交对已有功能的兼容，直到升级完成后删除legacy code。
* 尽最大可能保持每个提交都应该是完整且可测试的。

## 3. 自动化测试，保持主线版本健康
集成 CI 工具（如 Jenkins），确保每次提交都通过自动化测试。
* 测试失败时，阻止代码合并到主线。

## 4. 代码审查
每个提交都需要经过严格的代码审查。
* 提交必须开发review （Owner +1）
* 提交必须自动化测试通过 （CI +1， 极特殊情况在不打断CI和确认无功能破坏备案后申请豁免）
* 提交至少有一位使用方/同行评审（+1）
* 提交需获得至少一位核心开发者的批准（+2）
* 提交需要至少5分后开启merge通道，由仓库Owner或技术负责人最终操作合入
建立完善的代码审查制度的同时，要同步提升技术团队的代码审查文化
* 鼓励团队成员积极参与代码审查，提升代码质量。
* 评审者提供建设性反馈，帮助开发者改进代码。
* 评审者应关注代码质量、设计合理性和测试覆盖率，用自己的分数为版本质量负责。
* 提交后尽快解决评审意见，缩短合并周期。

## 5. 特性开关 - （模块feature化设计的最常见问题）
如果某个特性尚未完成但代码需要合并到主线，或模块开启整改但需要保持现有兼容（行车中换轮胎，属于gerrit的基操），可以使用特性开关（Feature Flags）来控制其是否生效。

示例：https://gerrit.gravityxr.cn/c/peripheral/common/+/10312 APIF驱动API模型升级整改前的兼容化patch；而后可以独立在V2控制下进行主干不影响的独立迭代；自测试通过后与相关调用方在一个topic的范围完成整体的升级/验证；最后删除legacy code：整个过程不打断主线功能，同时保持主干历史清晰/完整。


# 四、何时使用特性分支
虽然 Gerrit 推荐主线迭代，但在某些确定或一定阶段容许与主干不兼容，且过程时间跨度较长同时提交会比较多的场景下，特性分支仍然是必要的：
* **实验性开发** - 某些高风险或实验性的功能，可能需要独立分支进行验证，以保证主干的clean。
* **涉及范围较大且周期长的新功能开发或整改** - 如果某个特性需要较长时间开发，且无法拆分为小任务，可以使用阶段特性分支: 例如scenario集成验证 / product冲刺
* **版本发布** - 为发布版本创建独立分支，用于修复和测试，例如：BootROM先于正式product的发布，需要在freeze时固定分支的revision，ECO修改为了快速闭环就需要拉分支快速解决问题，防止其他可能的影响。

# 五、总结
* Gerrit 的主线迭代模式通过 小步提交、持续集成和严格审查，能够有效提高代码质量和开发效率。相比传统的特性分支，这种模式更适合现代软件开发，特别是涉及团队多，模块/特性复杂的较大规模的开发的需求。
* 既然部门选定了gerrit+repo作为SOC嵌软的work-flow，各team宜尽快向此方向迭代演进，做用正确的方法做正确的事情的技术长期主义